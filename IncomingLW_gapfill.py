
import pandas as pd
import numpy as np
import os
import datetime as dt
from scipy import stats
from scipy.optimize import curve_fit

#Import custom code for processing
import Gap_Fill_climatology_v2 as gap_fill_climatology
import meteorologicalfunctions as metfuncs
import gapfill_utilities_v3 as gf

###### Functions ######

# Modified Brutsaert equation
def LW_calc(array_test,a,b):
    return ((array_test[:,2]+(1-array_test[:,2])* # Cloud factor addition to Brutsaert emissivity
            (a*((array_test[:,1]*10)/(array_test[:,0]+273.15))**b))* # Brutsaert emissivity
            (5.67/10**8)*(array_test[:,0]+273.15)**4)   # Stefan Boltzmann

# Locate closest data points in record
def find_nearest(dateObj):
    ind=pd.date_range(dateObj,periods=1440/rec_length,freq=freq_str)
    NearDays_DF=abs(DaySum_DF_global['Obs_LW']-DaySum_DF_global['LW_est'][dateObj])
    NearDays_DF.sort()
    NearDays_DF=NearDays_DF[:10]
    NearData_DF=pd.concat([LW_DF_global[VarToProcess][dt.datetime.strftime(j,'%Y-%m-%d')] for j in NearDays_DF.index])
    temp_DF=NearData_DF.groupby([lambda x: x.hour,lambda y: y.minute]).mean()
    temp_DF.index=ind
    return temp_DF
#------------------------------------------------------------------------------
    

#------------------------------------------------------------------------------
# MAIN CODE
#------------------------------------------------------------------------------

def Fld_gapfill(variable_to_fill,myBaseforResults,mypathforAWAPdata,FileName_AWAPData,FLUXDataframe,Site_ID,fluxfreq):


    ###### Set constants ######
    
    # Globals
    global VarToProcess
    VarToProcess=variable_to_fill
    global rec_length
    rec_length=int(fluxfreq[:2])
    global freq_str
    freq_str=fluxfreq
    
    # Locals
    groupby_string='week'  # Frequency of binning for climatology: dayofyear, week, month
    avail_data_threshold=30
    write_to_DF=True
              
          
    ###### Set I/O ######
    
    print "Starting Fld gap filling"
    #Check for place to put results - does it exist? If not create
    if not os.path.isdir(myBaseforResults):
	os.mkdir(myBaseforResults)
    #Then subdirectories
    if not os.path.isdir(myBaseforResults+"/ANCILLARY"):
	os.mkdir(myBaseforResults+"/ANCILLARY")
    mypathforResults=myBaseforResults+"/ANCILLARY"  
        
    # Read in cloud fraction ancillary data file
    InputPathName_CLFData=mypathforResults+'/Daily Solar Calculations AWAP and Obs for '+Site_ID+'.csv'
    varNames_CLF=['DT','Cloud_factor']    
    if os.path.exists(InputPathName_CLFData):
        CLF_DF=pd.read_csv(InputPathName_CLFData,sep=',',usecols=varNames_CLF,parse_dates=[0],index_col=varNames_CLF[0])
        CLF_avail=True
    else:
        print 'Missing cloud fraction file - it can be generated by running the insolation gap-filling routine'
        print '                            - using unmodified Brutsaert calculation with default coefficients'
        CLF_avail=False
                   
    ###### Calculate daily averages for obs ######
    
    #Create vapour pressure variable in DF
    FLUXDataframe['E']=metfuncs.vapourpressure(FLUXDataframe['Ah_Con'],FLUXDataframe['Ta_Con'])   
       
    #Average observational met and LW_in data
    DaySum_DF=pd.DataFrame({'Obs_Ta':FLUXDataframe['Ta_Con'].groupby([lambda x: x.year, lambda y: y.dayofyear]).mean(),
                            'Obs_E':FLUXDataframe['E'].groupby([lambda x: x.year, lambda y: y.dayofyear]).mean()*10,
                            'Obs_LW':FLUXDataframe['Fld'].groupby([lambda x: x.year, lambda y: y.dayofyear]).mean(),
                            'ObsLW_count':FLUXDataframe['Fld'].groupby([lambda x: x.year, lambda y: y.dayofyear]).count()}).reset_index()
    DaySum_DF['Obs_LW']=np.where(DaySum_DF['ObsLW_count']==1440/rec_length,DaySum_DF['Obs_LW'],np.nan)
    
    #Generate dates from group names (year and day of year)
    DaySum_DF.index=(DaySum_DF['level_0'].apply(lambda x: dt.datetime(x,1,1))+
                     DaySum_DF['level_1'].apply(lambda x: dt.timedelta(int(x)-1)))        
    DaySum_DF.drop(['level_0','level_1','ObsLW_count'],axis=1,inplace=True)

    #Add cloud fraction and DOY variables
    #CLF_DF.reindex(DaySum_DF.index,inplace=True)
    CLF_DF.reindex(DaySum_DF.index)
    DaySum_DF['CLF']=CLF_DF['Cloud_factor']
    DaySum_DF['DOY']=[i.timetuple().tm_yday for i in DaySum_DF.index]
    
    ###### Optimisation and calculation of estimated daily incoming longwave radiation ######         

    # Check if LW data present, then if so check how much
    if VarToProcess in FLUXDataframe.columns:
        
        avail_data=round(float(FLUXDataframe[VarToProcess].count())/len(FLUXDataframe)*100,2)
        
        if avail_data>avail_data_threshold:
            
            proc_var=True #Enable processing variable
            print 'Fitting Brutsaert coefficients... (Data available = ' + str(avail_data) + '%, minimum data threshold passed, set to = ' + str(avail_data_threshold) + '%)'
            
            #Create arrays to pass to optimisation algorithm
            opt_array=np.array(DaySum_DF[['Obs_Ta','Obs_E','CLF','Obs_LW']])
            opt_array=opt_array[~np.isnan(opt_array).any(axis=1)]
            
            #Optimise Brutsaert coefficients
            coeffs_opt,cov_opt=curve_fit(LW_calc,opt_array[:,0:3],opt_array[:,3],p0=(1,0.5))
    
        else:
            proc_var=False 
            print 'Setting default Brutsaert coefficients... (Data available = ' + str(avail_data) + '%, minimum data threshold failed, set to = ' + str(avail_data_threshold) + '%)'
                       
    else: 
        proc_var=False
        print 'Variable '+VarToProcess+' not available, setting default Brutsaert coefficients'
        
    if not proc_var: coeffs_opt=[1.24,0.17] #If no or too few longwave obs, just use the original Brutsaert coefficients
    
                                    
    #Spit out stats
    print 'Ldown=Epsilon*5.67*10^-8*T^4'
    print 'Epsilon=CLF+(1-CLF)*a(E/T)^b'
    print 'Where - a and b are Brutsaert coefficients: a='+str(round(coeffs_opt[0],3))+', b='+str(round(coeffs_opt[1],3))
    print '      - CLF=cloud fraction (1-daily observed Kdown/clear sky estimated Kdown),'
    print '      - T=temperature in K, E=vapour pressure in hPa'
    
    if proc_var==True:
        
        #Calculate daily mean longwave radiation for each day in series
        DaySum_DF['LW_est']=LW_calc(np.array(DaySum_DF[['Obs_Ta','Obs_E','CLF']]),coeffs_opt[0],coeffs_opt[1])
       
        # Create globals
        global LW_DF_global
        LW_DF_global=FLUXDataframe#[VarToProcess]
        global DaySum_DF_global                              
        DaySum_DF_global=DaySum_DF
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        #Get results and insert into new DF
        rslt_DF=pd.DataFrame({'Ldown_est':pd.concat([find_nearest(dateObj) for dateObj in DaySum_DF.index])},
                              index=FLUXDataframe.index)
      
    else:
        # Use cloud factor data and standard Brutsaert coefficients
        rslt_DF=pd.DataFrame(index=FLUXDataframe.index,columns=['CLF','Ldown_est'])
        rslt_DF['CLF']=1
        DaySum_DF['DT']=DaySum_DF.index.date
        DaySum_DF['DT']=DaySum_DF['DT'].apply(lambda x: dt.datetime.strftime(x,'%Y-%m-%d'))
        if CLF_avail==True:
            rslt_DF['CLF']=pd.concat([rslt_DF['CLF'].ix[i]*DaySum_DF['CLF'].ix[i] for i in DaySum_DF['DT']])
        arr=np.ndarray(shape=(len(FLUXDataframe),3),dtype=float)        
        arr[:,0]=rslt_DF['CLF']
        arr[:,1]=FLUXDataframe['Ta_Con']
        arr[:,2]=FLUXDataframe['E']
        rslt_DF=pd.DataFrame({'Ldown_est':LW_calc(arr,coeffs_opt[0],coeffs_opt[1])},index=FLUXDataframe.index)
        
    ###### Generate output and return new variables ######

    write_to_DF=True
    if write_to_DF==True:
		
	#Create a new label for pandas df column for the contructed variable (and the QC flag) and column to fill label
	construct_label=str(VarToProcess+"_Con")
	FLUXDataframe[construct_label]=np.nan
	#add a column for the constructed QC flag
	#This will be 1 if valid data from the tower else 99
	construct_flag_label=str(VarToProcess+"_Con_QCFlag")
	FLUXDataframe[construct_flag_label]=np.nan
	#Create a series that is just the correlated output of CABLE adjusted to Tower
	corr_label=str(VarToProcess+"_Corr")
	FLUXDataframe[corr_label]=np.nan	
	
	#Start by filling with valid  values from tower
	FLUXDataframe[construct_flag_label][FLUXDataframe[VarToProcess].notnull()]=1
	FLUXDataframe[construct_label][FLUXDataframe[VarToProcess].notnull()]=FLUXDataframe[VarToProcess]
	#Fill with series calculated here
	FLUXDataframe[construct_flag_label][FLUXDataframe[construct_flag_label].isnull()]=99
 
	FLUXDataframe[corr_label]=rslt_DF['Ldown_est']
 
	FLUXDataframe[construct_label][FLUXDataframe[construct_flag_label]==99]=FLUXDataframe[corr_label]
     	
    ###########################################
    # Call function to do climatology gap fill#
    ###########################################
    
    FLUXDataframe=gap_fill_climatology.climatology_monthly_diurnal(FLUXDataframe,VarToProcess)    
    
    print "Finished Fld gapfilling returning DF"
    return FLUXDataframe
  
    